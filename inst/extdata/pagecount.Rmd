---
title: "Pagecount preprocessing summary"
author: "`r author`"
date: "`r Sys.Date()`"
output: markdown_document
---

```{r init, echo=FALSE}
#opts_chunk$set(comment=NA, fig.width=6, fig.height=6)
opts_chunk$set(fig.path = "figure/pagecount-")
df <- df.preprocessed
```


## Page counts

  * Page count available for `r sum(!is.na(df$pagecount))` documents in total (`r round(100*(sum(!is.na(df$pagecount)))/nrow(df), 1)`%), including both readily available and estimated page counts.

  * Page count readily available for `r sum(!is.na(df$pagecount.orig))` documents (`r round(100*(sum(!is.na(df$pagecount.orig)))/nrow(df), 1)`%). 

  * Page count estimated for `r sum(!is.na(df$pagecount)) - sum(!is.na(df$pagecount.orig))` documents (`r round(100*(sum(!is.na(df$pagecount)) - sum(!is.na(df$pagecount.orig)))/nrow(df), 1)`%).

  * Page count missing and could not be estimated for `r sum(is.na(df.preprocessed$pagecount.orig) & is.na(df.preprocessed$pagecount))` documents (`r round(100 * sum(is.na(df.preprocessed$pagecount.orig) & is.na(df.preprocessed$pagecount))/nrow(df.preprocessed), 1)`%).

  * Page count updated for `r sum(!df$pagecount.orig == df$pagecount, na.rm = T)` documents in the validation phase.
  
  * [Conversions from raw data to final page count estimates](output.tables/pagecount_conversions.csv)

  * [Augmented pagecounts](output.tables/pagecount_discarded.csv) For these cases the page count is missing (or discarded) in the original data, and estimated based on median page counts for [single volume](mean_pagecounts_singlevol.csv), [multi-volume](mean_pagecounts_multivol.csv) and [issues](mean_pagecounts_issue.csv), calculated from those documents where page count info was available.

  * [Automated unit tests for page count conversions](https://github.com/rOpenGov/bibliographica/blob/master/inst/extdata/tests_polish_physical_extent.csv) - these are used to control that the page count conversions remain correct when changes are made to the cleanup routines


Left: Gatherings vs. overall pagecounts (original + estimated). Right: Only the estimated page counts (for the `r sum(!is.na(df$pagecount)) - sum(!is.na(df$pagecount.orig))` documents that have missing pagecount info in the original data):

```{r size-estimated, echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height=6, fig.show="hold", out.width="430px"}
theme_set(theme_bw(20))
dfs <- select(df, pagecount, gatherings) 
dfs$pagecount <- as.numeric(gsub(" pages", "", dfs$pagecount))
dfs <- dfs %>% filter(!is.na(pagecount) & !is.na(gatherings))
dfg <- group_by(dfs, pagecount, gatherings) %>% tally()
names(dfg) <- c("pages", "gatherings", "documents")
dfg$gatherings <- factor(dfg$gatherings, levels = levels(df$gatherings))
ylims <- range(dfg$pages)
p <- ggplot(dfg, aes(x = gatherings, y = pages)) 
#p <- p + scale_y_continuous(trans = "log10")
n <- 1 + nchar(max(na.omit(table(dfg$pages))))
ylim <- ylim(ylims)
p <- p + scale_y_log10(breaks=10^(0:n))
p <- p + geom_point(aes(size = documents))
p <- p + scale_size(trans="log10")
p <- p + ggtitle(paste("Estimated and original pages\n(n=", sum(dfg$documents), ")", sep = ""))
p <- p + xlab("Size (gatherings)")
p <- p + ylab("Pages (original and estimated)")
p <- p + coord_flip()
print(p)

dfs <- subset(df.preprocessed, is.na(pagecount.orig) & !is.na(pagecount))
p <- ggplot(dfs,
       aes(x = gatherings, y = pagecount)) +
       geom_count() +
       scale_y_log10(breaks=10^(0:n)) +
       coord_flip() +
       ggtitle(paste("Estimated page counts\n(n=", sum(is.na(df.preprocessed$pagecount.orig) & !is.na(df.preprocessed$pagecount)), ")", sep = "")) +
       xlab("Gatherings") +
       ylab("Estimated page count")
print(p)
```



## Average page counts

Mean and median page counts calculated based on the documents where
the page count information was readily available. Also see the
correponding numerical tables with page count estimates:

 * [Single volume](mean_pagecounts_singlevol.csv)
 * [Multi-volume](mean_pagecounts_multivol.csv)
 * [Issue](mean_pagecounts_issue.csv)

These estimates are used to fill in page count info for the remaining
documents where page count info is missing.

The multi-volume documents average page counts are given per volume.

The page count estimates are calculated without plates. Plate
information is added separately for each document on top of the page
count estimate.

```{r size-pagecountsmulti, echo=FALSE, message=FALSE, warning=FALSE}
mean.pagecounts <- get_mean_pagecounts(df, exclude.plates = TRUE)
```

```{r size-pagecountsmulti2, echo=FALSE, message=FALSE, warning=FALSE, fig.width=25, fig.height=5}
theme_set(theme_bw(20))
dfs <- NULL
for (doctype in names(mean.pagecounts)) {
  mpc <- as.data.frame(mean.pagecounts[[doctype]])
  mpc$doctype <- rep(doctype, nrow(mpc))
  dfs <- rbind(dfs, mpc)
}
dfs$doctype <- gsub("multivol", "multi-volume", dfs$doctype)
dfs$doctype <- gsub("singlevol", "single volume", dfs$doctype)
dfs$doctype <- factor(dfs$doctype, levels = c("single volume", "multi-volume", "issue"))
colnames(dfs) <- gsub("\\.pages", "", colnames(dfs))

dfm <- melt(dfs, id = c("doctype", "doc.dimension", "n"))
dfm <- dfm[!dfm$doc.dimension == "NA", ]
dfm$doc.dimension <- droplevels(dfm$doc.dimension)
dfm <- filter(dfm, !is.na(value))

p <- ggplot(dfm, aes(color = doctype, shape = variable, y = value, x = doc.dimension))
p <- p + geom_point(stat = "identity", position = "dodge", size = 5)
p <- p + ylab("Pages")
p <- p + xlab("")
p <- p + coord_flip()
p <- p + ggtitle(paste("Estimated page counts"))
#p <- p + scale_size_continuous(limits=range(dfm$n), range=c(3, 10))
lims <- range(na.omit(c(dfs$mean, dfs$median)))
pics <- list()
pics[[1]] <- p
for (doct in unique(dfs$doctype)) {
  dfm <- subset(dfs, doctype == doct)
  dfm <- melt(dfm, id = c("doctype", "doc.dimension", "n"))
  dfm <- filter(dfm, !is.na(value))  
  #dfm <- dfm[!dfm$doc.dimension == "NA", ]
  #dfm$doc.dimension <- droplevels(dfm$doc.dimension)
  
  p <- ggplot(dfm, aes(fill = variable, y = value, x = doc.dimension))
  p <- p + geom_bar(stat = "identity", position = "dodge")
  p <- p + ylab("Pages")
  p <- p + xlab("")
  p <- p + coord_flip()
  p <- p + ggtitle(doct)
  p <- p + ylim(0, max(lims))
  
  pics[[doct]] <- p
}

suppressWarnings(grid.arrange(pics[[1]], pics[[2]], pics[[3]], pics[[4]], nrow = 1))

#kable(mean.pagecounts$singlevol, caption = "Estimated page counts (single volume)", digits = 2)
#kable(mean.pagecounts$multivol, caption = "Estimated page counts (multi-volume)", digits = 2)
#kable(mean.pagecounts$issue, caption = "Estimated page counts (issues)", digits = 2)
```


